import discord
from discord.ext import commands, tasks
from discord.utils import get
from discord_components import DiscordComponents, Button, ButtonStyle, Select, SelectOption
import contextlib
import io
import os
import logging
import aiohttp
import aeval
import sys
import time
import youtube_dl


import datetime
import requests
from db import DataBase
from Cybernator import Paginator
#import time
import asyncio
import random

PREFIX = '$'

client = commands.Bot(command_prefix = PREFIX)
client.remove_command('help')
hello = ['hello', 'hi', '–ø—Ä–∏–≤–µ—Ç', '—Ö–∞–π', '–∑–¥–∞—Ä–æ–≤–∞', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ', 'ky', 'privet', '–∫—É']
goodbye = ['–ø–æ–∫–∞', 'bye']

db = DataBase()

 
def minify_text(txt):
    if len(txt) >= 1024:
        return f'''{str(txt)[:-900]}...
        ...–∏ –µ—â—ë {str(txt).replace(str(txt)[:-900], "")} —Å–∏–º–≤–æ–ª–æ–≤...'''
    else:
        return str(txt)

@client.event
async def on_ready():
	await db.create_table()
	for guild in client.guilds:
	#	print(guild.members)
		for member in guild.members:
			#print(member)
			await db.insert_new_member(member)
	DiscordComponents(client)
	print('BOT ready')
	
	
	await client.change_presence(activity=discord.Streaming(name='–∫–æ–º–∞–Ω–¥—É {}help'.format(PREFIX), url="https://www.twitch.tv/qrushcsgo"))
	
	
@client.event
async def on_member_join(member):
	await db.insert_new_member(member)



@client.event
async def on_command_error(ctx, error):
	if isinstance(error, commands.MissingPermissions):
		emd = discord.Embed(title = 'üõë–û—à–∏–±–∫–∞üõë', colour=discord.Color.red())
		emd.add_field(value=f'{ctx.author.name} —Å–æ–≤–µ—Ä—à–∏–ª –æ—à–∏–±–∫—É!!', name = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤!!')
		emd.set_footer(text = ctx.author.name, icon_url = ctx.author.avatar_url)
		await ctx.send(embed = emd)
	elif isinstance(error, commands.CommandNotFound):
		emd = discord.Embed(title = 'üõë–û—à–∏–±–∫–∞üõë', colour=discord.Color.red())
		emd.add_field(value=f'{ctx.author.name} —Å–æ–≤–µ—Ä—à–∏–ª –æ—à–∏–±–∫—É!!', name = '–ö–æ–º–∞–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ {}help'.format(PREFIX))
		emd.set_footer(text = ctx.author.name, icon_url = ctx.author.avatar_url)
		await ctx.send(embed = emd)
	print(error)
#	await ctx.send(error)

	
@client.event
async def on_message(message):
	await client.process_commands(message)
	msg = message.content.lower()
	
	if msg in hello:
		await message.channel.send('–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞')
	if msg in goodbye:
		await message.channel.send('–î–∞–≤–∞–π, –ø–æ–∫–∞ —Å–∫–æ—Ä–æ —É–≤–∏–¥–µ–º—Å—è')

#clear message
@client.command(pass_context = True)
@commands.has_permissions(administrator = True)
async def clear(ctx, amount : int):
	await ctx.channel.purge(limit=amount)
	
#kick
@client.command(pass_context = True)
@commands.has_permissions(administrator = True)
async def kick(ctx, member: discord.Member, *, reason = None):
	await ctx.channel.purge(limit=1)
	await member.kick(reason=reason)
	await ctx.send(f'–Ø –∫–∏–∫–Ω—É–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {member}')

#ban
@client.command(pass_context = True)
@commands.has_permissions(administrator = True)
async def ban(ctx, member: discord.Member, *, reason = None):
	await ctx.channel.purge(limit=1)
	await member.ban(reason=reason)
	await ctx.send(f'–Ø –∑–∞–±–∞–Ω–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {member}')

#help
@client.command(pass_context = True)
async def help(ctx):
	emd = discord.Embed(title = '–ú–æ–¥–∏—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã', description = '{}clear - –û—Ç—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞\n{}kick - –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞\n{}ban - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n{}mute - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç—É —Å–µ—Ä–≤–µ—Äa\n{}eval - –®—Ç—É–∫–∞ –¥–ª—è —Ä–∞–∑—Ä–æ–±–æ—Ç—á–∏–∫–∞'.format(PREFIX, PREFIX, PREFIX, PREFIX, PREFIX))
	
	emd2 = discord.Embed(title = '–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã', description = f'{PREFIX}time - –£–∑–Ω–∞—Ç—å –≤—Ä–µ–º—è\n{PREFIX}server - –£–∑–Ω–∞—Ç—å –∏–Ω—Ñ—É –æ —Å–µ—Ä–≤–µ—Ä–µ')
	emd3 = discord.Embed(title = '–ò–≥—Ä—ã', description = f'{PREFIX}8ball - –ò–≥—Ä–∞ –ø—Ä–æ –º–∞–∫–∏—á–µ—Å–∫–∏–π —à–∞—Ä–∏–∫\n{PREFIX}coin -–û—Ä—ë–ª –∏ –†–µ—à–∫–∞')
	emd4 = discord.Embed(title= '–≠–∫–æ–Ω–æ–º–∏–∫–∞', description = f'{PREFIX}cash - –£–∑–Ω–∞—Ç—å —Å–≤–æ–π –±–∞–ª–∞–Ω—Å\n{PREFIX}award - –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±–∞–ª–∞–Ω—Å')
	emd5 = discord.Embed(title= '–ú—É–∑—ã–∫–∞', description = f'{PREFIX}join - –ü—Ä–∏—Å–æ–µ–¥–∏—Ç—Å—è –∫ –∫–∞–Ω–∞–ª—É\n{PREFIX}leave - –í—ã–π—Ç–∏ –∏–∑ –∫–∞–Ω–∞–ª–∞\n{PREFIX}play - –°—ã–≥—Ä–∞—Ç—å –º—É–∑—ã–∫—É\n{PREFIX}pause - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º—É–∑—ã–∫—É\n{PREFIX}resume - –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–æ–∏–≥—Ä–æ–≤–∞–Ω–∏–µ')
	emds = [emd, emd2, emd3, emd4, emd5]
	
	message = await ctx.send(embed = emd)
	page = Paginator(client, message, only=ctx.author, use_more = False, embeds = emds)
	await page.start()
	
	

#mute
@client.command()
@commands.has_permissions(administrator = True)
async def mute(ctx, member:discord.Member):
	mute_role = discord.utils.get(ctx.message.guild.roles, name='mute')
	await member.add_roles(mute_role)
	
	
#time
@client.command()
async def time(ctx):
	emb = discord.Embed(title = '–í—Ä–µ–º—è', colour = discord.Color.green())
	emb.set_author(name = client.user.name, icon_url = client.user.avatar_url)
	emb.set_footer(text = ctx.author.name, icon_url = ctx.author.avatar_url)
	
	now_date = datetime.datetime.now()
	emb.add_field(name='Time', value = "Time:{}".format(now_date))
	
	await ctx.send(embed = emb)
	

#user info
#@client.command()
#async def user(ctx):
#	pass

#cash
@client.command()
async def cash(ctx, member: discord.Member = None):
	if member == None:
		await db.insert_new_member(ctx.author)
		cash = await db.get_data(ctx.author)
		await ctx.send(embed = discord.Embed(
			description = f"""–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **{ctx.author}** —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç **{cash['balance']}**"""
		))
	else:
		await db.insert_new_member(member)
		balance = await db.get_data(member)
		await ctx.send(embed = discord.Embed(
			description = f"""–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **{member}** —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç **{balance['balance']}**"""
		))



@client.command()
async def award(ctx, member: discord.Member, cash:int):
	if ctx.author.id == 707241794336718891:
		await db.update_member("UPDATE users SET balance = balance + ? WHERE member_id = ? AND guild_id = ?", [cash, member.id, ctx.guild.id])
		await ctx.message.add_reaction("üíñ")
	else:
		await ctx.send('–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–∞')


#eval 
@client.command()
async def eval(ctx, *, ucode=None):
	if ctx.author.id != 707241794336718891:
		emd = discord.Embed(title = 'üõë–û—à–∏–±–∫–∞üõë', colour=discord.Color.red())
		emd.add_field(value=f'{ctx.author.name} —Å–æ–≤–µ—Ä—à–∏–ª –æ—à–∏–±–∫—É!!', name = '–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–æ–±–æ—á–∏–∫–∞!!')
		emd.set_footer(text = ctx.author.name, icon_url = ctx.author.avatar_url)
		return await ctx.send(embed = emd)
	code = '\n'.join(ucode.split('\n')[1:])[:-3] if ucode.startswith('```') and ucode.endswith('```') else ucode
	libs = {
	'discord': discord,
	'commands': commands,
	'bot': client,
	'client': client,
	'ctx': ctx
	}
	try:
		reval = await aeval.aeval(code, libs, {})
		emb = discord.Embed(title=f'–£—Å–ø–µ—à–Ω–æ:',description=f'**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - \n```py\n{code}\n```\n'
                        f'**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - \n```py\n{reval}\n```\n', color=discord.Color.green())
		await ctx.send(embed=emb)
	except Exception as exception:
		emb = discord.Embed(title=f'–û—à–∏–±–∫–∞:',
    	description='**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - \n```py\n{code}\n```\n'
                        f'**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - \n```py\n{exception}\n```\n',
                        color=discord.Color.red())
		await ctx.send(embed=emb)

@client.command()
async def server(ctx):
    embed = discord.Embed(title = f"{ctx.guild.name}", description = "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ", color = discord.Colour.blue())
    embed.add_field(name = 'üÜîServer ID', value = f"{ctx.guild.id}", inline = True)
    embed.add_field(name = 'üìÜCreated On', value = ctx.guild.created_at.strftime("%b %d %Y"), inline = True)
    embed.add_field(name = 'üëëOwner', value = f"{ctx.guild.owner}", inline = True)
    embed.add_field(name = 'üë•Members', value = f'{ctx.guild.member_count} Members', inline = True)
    embed.add_field(name = 'üí¨Channels', value = f'{len(ctx.guild.text_channels)}Text | {len(ctx.guild.voice_channels)} Voice', inline = True)
    embed.add_field(name = 'üåéRegion', value = f'{ctx.guild.region}', inline = True)
    embed.set_thumbnail(url = ctx.guild.icon_url)
    embed.set_footer(text = "‚≠ê ‚Ä¢ Duo")
    embed.set_author(name = f'{ctx.author.name}', icon_url = ctx.message.author.avatar_url)
    await ctx.send(embed=embed)

#game
#8ball
@client.command(name = '8ball')
async def ball(ctx, ques=""):
	if ques=="":
		await ctx.send("–ó–∞–¥–∞–π –º–Ω–µ –≤–æ–ø—Ä—Å")
	else:
		choices = [
            '–ù–∞–¥–æ –ø–æ–¥—É–º–∞—Ç—å.', '–ú–æ–∂–µ—Ç –±—ã—Ç—å –¥–∞ –∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Ç', '–•–∑.', '–î–∞ - –ö–æ–Ω–µ—á–Ω–æ.', '–°–ø—Ä–æ—Å–∏ –º–µ–Ω—è –µ—â—ë-—Ä–∞–∑',
            '–Ø —Å–º–æ—Ç—Ä—é –∏ –≤–∏–∂—É –æ—Ç–≤–µ—Ç - –î–∞.', '–ù–µ—Ç.', 'Outlook good.', '–î–∞.'
            ]
		await ctx.send(f" {random.choice(choices)}")

#coin
@client.command() 
async def coin(ctx):
    Coin = {
        0: "***–û—Ä–µ–ª***",
        1: "***–†–µ—à–∫–∞***",
    }
    side_of_the_coin = random.randint(1, 1000)
    await ctx.send(f'{Coin[side_of_the_coin%2]}')

#music
#join
@client.command()
async def join(ctx):
    global voice
    try:
        if ctx.message.author.voice == None:
            await ctx.send(f'{ctx.message.author.mention}, –º–æ–∂–µ—Ç —Å–Ω–∞—á–∞–ª–∞ —Ç—ã –Ω–∞ –∫–∞–Ω–∞–ª –∑–∞–π–¥–µ—à—å?')
            return

        channel = ctx.author.voice.channel
        voice = await channel.connect()
    except:
        await ctx.send(f'–ù—É –Ω–µ –∫—Ä–∏—á–∏ —Ç—ã —Ç–∞–∫, —Ç—É—Ç —è, —Ç—É—Ç...')
        channel = ctx.author.voice.channel
        voice = await channel.connect()

#leave
@client.command()
async def leave(ctx):
    global voice
    try:
        #TrackQueue_1.clean()
        await ctx.voice_client.disconnect()
    except AttributeError:
        await ctx.send(f'–î–∞ —É—à–µ–ª —è —É–∂–µ, —É—à–µ–ª, —á—Ç–æ —Ç—ã —Ç–∞–∫–æ–π –∑–ª–æ–π?...')

#pause
@client.command()
async def pause(ctx):
	voice = discord.utils.get(client.voice_clients, guild = ctx.guild)
	if voice.is_playing():
		voice.pause()
	else:
		await ctx.send('–í—ã –Ω–µ –º–æ–∂–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º—É–∑—ã–∫—É')
		
#resume
@client.command()
async def resume(ctx):
	voice = discord.utils.get(client.voice_clients, guild = ctx.guild)
	if voice.is_paused():
		voice.resume()
	else:
		await ctx.send('–í—ã –Ω–µ –º–æ–∂–∏—Ç–µ –≤–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É')

@client.command()
async def play(ctx, url: str):

    def check_queue():
        Queue_infile = os.path.isdir("./Queue")
        if Queue_infile is True:
            DIR = os.path.abspath(os.path.realpath("Queue"))
            length = len(os.listdir(DIR))
            still_q = length - 1
            try:
                first_file = os.listdir(DIR)[0]
            except:
                print("No more queded song(s)\n")
                queues.clear()
                return
            main_location = os.path.dirname(os.path.realpath(__file__))
            song_path = os.path.abspath(os.path.realpath("Queue") + "\\" + first_file)
            if length != 0:
                print("Song done, playing next queued\n")
                print(f"Songs still in queue: {still_q}")
                song_there = os.path.isfile("song.mp3")
                if song_there:
                    os.remove("song.mp3")
                shutil.move(song_path, main_location)
                for file in os.listdir("./"):
                    if file.endswith(".mp3"):
                        os.rename(file, 'song.mp3')
                voice.play(discord.FFmpegPCMAudio("song.mp3"), after=lambda e: check_queue())
                voice.source = discord.PCMVolumeTransformer(voice.source)
                voice.source.volume = 0.07
            else:
                queues.clear()
                return
        else:
            queues.clear()
            print("No songs were queued before the ending of the last song\n")
    previous_song = os.path.isfile("song.mp3")
    try:
        if previous_song:
            os.remove("song.mp3")
            queues.clear()
            print("Removed old song file")
    except PermissionError:
        print('Trying to delete song file, but it is playing')
        await ctx.send("Silly {0.display_name}, I am playing this song now".format(ctx.author))
        return
    
    Queue_infile = os.path.isdir("./Queue")

    try:
        Queue_folder = ("./Queue")
        if Queue_infile is True:
            print("Removed old queue folder")
            shutil.rmtree(Queue_folder)
    except:
        print("No old Queue folder")

    await ctx.send("Braum is on the job!") 

    voice = get(client.voice_clients, guild = ctx.guild)
    ydl_opts = {
         'format': 'bestaudio/best',
         'quiet': True,
         'postprocessors':[{
            'key':'FFmpegExtractAudio',
            'preferredcodec':'mp3',
            'preferredquality':'192',
        }]
    }
    with youtube_dl.YoutubeDL(ydl_opts) as ydl:
        print('Downloading audio now\n')
        ydl.download([url])
    for file in os.listdir("./"):
        if file.endswith(".mp3"):
            name = file
            print(f"Renamed File: {file}\n")
            os.rename(file, "song.mp3")
    voice.play(discord.FFmpegPCMAudio("song.mp3"), after=lambda e: check_queue())
    voice.source = discord.PCMVolumeTransformer(voice.source)
    voice.source.volume = 0.07

    nname = name.rsplit("-", 2)
    await ctx.send(f"Playing: {nname}")
    print("Playing\n")

#error
@clear.error
async def clear_error(ctx, error):
	if isinstance(error, commands.MissingRequiredArgument):
		emd = discord.Embed(title = 'üõë–û—à–∏–±–∫–∞üõë', colour=discord.Color.red())
		emd.add_field(value=f'{ctx.author.name} —Å–æ–≤–µ—Ä—à–∏–ª –æ—à–∏–±–∫—É!!', name = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª-–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π')
		emd.set_footer(text = ctx.author.name, icon_url = ctx.author.avatar_url)
		await ctx.send(embed = emd)
	
@ban.error
async def ban_error(ctx, error):
	if isinstance(error, commands.MissingRequiredArgument):
		emd = discord.Embed(title = 'üõë–û—à–∏–±–∫–∞üõë', colour=discord.Color.red())
		emd.add_field(value=f'{ctx.author.name} —Å–æ–≤–µ—Ä—à–∏–ª –æ—à–∏–±–∫—É!!', name = '–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–∞–Ω–∏—Ç—å')
		emd.set_footer(text = ctx.author.name, icon_url = ctx.author.avatar_url)
		await ctx.send(embed = emd)

@kick.error
async def kick_error(ctx, error):
	if isinstance(error, commands.MissingRequiredArgument):
		emd = discord.Embed(title = 'üõë–û—à–∏–±–∫–∞üõë', colour=discord.Color.red())
		emd.add_field(value=f'{ctx.author.name} —Å–æ–≤–µ—Ä—à–∏–ª –æ—à–∏–±–∫—É!!', name = '–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ –∫–∏–∫–Ω—É—Ç—å')
		emd.set_footer(text = ctx.author.name, icon_url = ctx.author.avatar_url)
		await ctx.send(embed = emd)


@mute.error
async def mute_error(ctx, error):
	if isinstance(error, commands.MissingRequiredArgument):
		emd = discord.Embed(title = 'üõë–û—à–∏–±–∫–∞üõë', colour=discord.Color.red())
		emd.add_field(value=f'{ctx.author.name} —Å–æ–≤–µ—Ä—à–∏–ª –æ—à–∏–±–∫—É!!', name = '–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–º—å—é—Ç–∏—Ç—å')
		emd.set_footer(text = ctx.author.name, icon_url = ctx.author.avatar_url)
		await ctx.send(embed = emd)


@award.error
async def award_error(ctx, error):
	if isinstance(error, commands.MissingRequiredArgument):
		emd = discord.Embed(title = 'üõë–û—à–∏–±–∫–∞üõë', colour=discord.Color.red())
		emd.add_field(value=f'{ctx.author.name} —Å–æ–≤–µ—Ä—à–∏–ª –æ—à–∏–±–∫—É!!', name = '–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å—É–º–º—É')
		emd.set_footer(text = ctx.author.name, icon_url = ctx.author.avatar_url)
		await ctx.send(embed = emd)
		

token = open('token.txt', 'r').readline()
client.run(token)